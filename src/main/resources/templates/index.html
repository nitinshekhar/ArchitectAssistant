<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLaMA UML Designer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Element references
    const userRequestInput = document.getElementById('userRequest');
    const sendBtn = document.getElementById('sendBtn');
    const chatHistoryDiv = document.getElementById('chatHistory');
    const newDesignBtn = document.getElementById('newDesignBtn');
    const backendStatus = document.getElementById('backendStatus');

    let conversationHistory = []; // Stores the conversation history

    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);

    userRequestInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    newDesignBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (confirm('Are you sure you want to start a new design? This will clear the current conversation.')) {
        conversationHistory = [];
        chatHistoryDiv.innerHTML = '<div class="message assistant-message"><p>Hello! Im your AI Architect Assistant. Tell me about the software system you want to design, and Ill generate a C4 model diagram and explanation for you.</p></div>';
      }
    });

    function sendMessage() {
      const requestText = userRequestInput.value.trim();
      if (requestText === '') return;

      appendMessage(requestText, 'user');
      userRequestInput.value = '';
      userRequestInput.focus();

      // Show the status notifier
      backendStatus.style.display = 'block';
      // showLoadingIndicator();

      // Add user message to history
      conversationHistory.push({ message: requestText, sender: 'USER' });

      fetch('/api/design', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ request: requestText, conversationHistory: conversationHistory }),
      })
      .then(response => response.json())
      .then(data => {
        // removeLoadingIndicator();
        if (data.success) {
          // Add assistant message to history
          conversationHistory.push({ message: data.explanation, sender: 'ASSISTANT', design: data });
          appendMessage(data.explanation, 'assistant');
          //if (data.diagramPath) {
          if (data.diagramFilename) { // Use diagramFilename for consistency
            //appendDiagram(data.diagramPath, data.diagramFilename);
            appendDiagram(data.diagramFilename);
          }
          if (data.plantUmlCode) {
            appendPlantUMLCode(data.plantUmlCode);
          }
        } else {
          const errorMessage = data.errorMessage || 'An unknown error occurred.';
          conversationHistory.push({ message: errorMessage, sender: 'ASSISTANT' });
          appendMessage('Error: ' + errorMessage, 'assistant error');
        }
        //chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom
      })
      .catch(error => {
        //removeLoadingIndicator();
        console.error('Error:', error);
        conversationHistory.push({ message: 'Failed to connect to the server.', sender: 'ASSISTANT' });
        appendMessage('Error: Failed to connect to the server.', 'assistant error');
        //chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom
      })
      .finally(() => {
      backendStatus.style.display = 'none';
      chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
      });
    }

    function appendMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', `${sender}-message`);
      //Basic Sanitization for text content to prevent HTML injection
      const p = document.createElement('p');
      p.textContent = text;
      messageDiv.appendChild(p);
      // messageDiv.innerHTML = `<p>${text}</p>`;
      chatHistoryDiv.appendChild(messageDiv);
    }

    function appendDiagram(diagramFilename) {
      const diagramContainer = document.createElement('div');
      diagramContainer.classList.add('message', 'assistant-message', 'diagram-message');
      const imgPath = `/diagram/${diagramFilename}`; // Assuming diagramPath is like './uml-diagram/filename.png'
      diagramContainer.innerHTML = `
        <h5>Generated UML Diagram:</h5>
        <div class="diagram-image-container">
          <img src="${imgPath}" alt="Generated UML Diagram" class="img-fluid">
        </div>
        <a href="${imgPath}" class="btn btn-sm btn-outline-primary mt-2" download="${diagramFilename}">
          <i class="fas fa-download me-1"></i>Download Diagram
        </a>
      `;
      chatHistoryDiv.appendChild(diagramContainer);
    }

    function appendPlantUMLCode(code) {
      const codeContainer = document.createElement('div');
      codeContainer.classList.add('message', 'assistant-message', 'code-message');
      const codeId = `plantuml-code-${Date.now()}`;
      codeContainer.innerHTML = `
        <h5>PlantUML Source Code:</h5>
        <button class="btn btn-sm btn-outline-light mb-2" onclick="copyToClipboard(event, '${codeId}')">
          <i class="fas fa-copy me-1"></i>Copy Code
        </button>
        <pre><code id="${codeId}" class="language-plantuml">${escapeHtml(code)}</code></pre>
      `;
      chatHistoryDiv.appendChild(codeContainer);
      Prism.highlightElement(document.getElementById(codeId)); // Highlight the code
    }

     window.copyToClipboard = function(event, elementId) {
      const element = document.getElementById(elementId)
      if (!element) {
        console.error('Could not find element with ID:', elementId);
        return;
      }

      const text = element.textContent;

      navigator.clipboard.writeText(text).then(function() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-light');

        setTimeout(function() {
          button.innerHTML = originalHtml;
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-light');
          }, 2000);
        }).catch(function(err) {
          console.error('could not copy text: ', err);
      });
    }

    function showLoadingIndicator() {
      const loadingDiv = document.createElement('div');
      loadingDiv.classList.add('message', 'assistant-message', 'loading-indicator');
      loadingDiv.id = 'loadingIndicator';
      loadingDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin me-2"></i>Thinking...</p>';
      chatHistoryDiv.appendChild(loadingDiv);
      chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }

    function removeLoadingIndicator() {
      const loadingDiv = document.getElementById('loadingIndicator');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }

    // Helper to escape HTML for displaying code
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Llama status check
    const llamaStatus = document.getElementById('llamaStatus');

    function checkLlamaStatus() {
        fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                if (data.isLlamaRunning) {
                    llamaStatus.classList.remove('text-danger');
                    llamaStatus.classList.add('text-success');
                    llamaStatus.querySelector('i').classList.remove('fa-fade');
                } else {
                    llamaStatus.classList.remove('text-success');
                    llamaStatus.classList.add('text-danger');
                    llamaStatus.querySelector('i').classList.add('fa-fade');
                }
            })
            .catch(error => {
                console.error('Error checking Llama status:', error);
                llamaStatus.classList.remove('text-success');
                llamaStatus.classList.add('text-danger');
                llamaStatus.querySelector('i').classList.add('fa-fade');
            });
    }

    // Check status immediately and then every 15 seconds
    checkLlamaStatus();
    setInterval(checkLlamaStatus, 15000);
  });
</script>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/">
      <i class="fas fa-robot me-2"></i>My UML Designer
    </a>
    <div class="navbar-nav ms-auto">
      <div id="llamaStatus" class="nav-link">
        <i class="fas fa-circle me-1"></i>LLaMA Status
      </div>
      <a class="nav-link" href="#" id="newDesignBtn">
        <i class="fas fa-plus-circle me-1"></i>New Design
      </a>
    </div>
  </div>
</nav>

<!-- Status Notifies element -->
<!-- Status Notifier element -->
<div id="backendStatus" class="alert alert-info text-center" role="alert" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1050; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
  <i class="fas fa-spinner fa-spin me-2"></i>The assistant is processing your request...
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card chat-card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Architect Assistant Chat</h5>
        </div>
        <div class="card-body chat-history" id="chatHistory">
          <!-- Chat messages will be appended here -->
          <div class="message assistant-message">
            <p>Hello! I'm your AI Architect Assistant. Tell me about the software system you want to design, and I'll generate a C4 model diagram and explanation for you.</p>
          </div>
        </div>
        <div class="card-footer">
          <div class="input-group">
            <textarea id="userRequest" class="form-control" placeholder="Describe your system or ask a follow-up question..." rows="2"></textarea>
            <button class="btn btn-primary" type="button" id="sendBtn">
              <i class="fas fa-paper-plane me-2"></i>Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="bg-dark text-light py-4 mt-5">
  <div class="container text-center">
    <p class="mb-0">
      <i class="fas fa-code me-2"></i>
      Powered by LLaMA.cpp, Langchain4j, and PlantUML
    </p>
  </div>
</footer>
</body>
</html>